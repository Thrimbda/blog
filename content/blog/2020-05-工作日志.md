---
title: 2020-05 工作日志
date: 2020-05-01
taxonomies:
  tags:
    - 工作日志
    - 月度总结
    - 技术
    - 面试
    - bug修复
---

### 2020-05-06
#### Du Valid
- 使用mill
- 使用nexus-osm

#### Brain Strom

### 2020-05-08
#### 内存泄漏问题
- 内存泄漏问题的直接原因是因为new 了野指针之后没有delet
- 在update current position之后 map kit 调用了prepareGuidanceData，目的是找到离当前位置最近的guidance data
- prepareGuidanceData调用了NavInfoProviderImpl::getTrafficLights & NavInfoProviderImpl::getCarParks
- 以NavInfoProviderImpl::getTrafficLights为例，是在调用时new出NaviEventOnPath中的数据指针
- 然而并没有delete
- 还发现DestEvent存在这个问题

解决方案：核心在于不允许野指针存在，决定对NaviEventProvider做一个重构
- 首先在NaviInfoProvider中添加两个field traffic_light_events_ & car_park_events_
- 在NaviInfoGenerator中，route updated之后更新这两个field
- 然后在每次get的时候根据当前车辆位置做一个过滤
- 因此要重构`PathReader::getAttributes`，原因在于之前的实现只考虑了相对于当前车的offset，现在需要一个相对于Path的Offset接口

### 2020-05-09
#### PolyLine修复以及测试
PolyLine的问题主要在于有可能在PolyLine生成的时候给重复点进去，从而导致一系列几何有关segment的计算问题：
1. 向量计算，两个重复点计算出零向量
2. 长度计算，segment长度为0，很容易出Nan问题

于是在构造PolyLine时，对PolyLine中的点进行检查，如果有发现重复点，就抛出异常

检查出下列问题：
- Jts中getEnd出现问题
- Jts LinearLocation会存在normalize的问题
  ```scala
  val loc1 = new LinearLocation(0, 1, 1.0)
  val loc2 = new LinearLocation(0, 2, 0.0)
  
  loc1 compareTo loc2
  // the output is -1
  ```
- Interpolate的时候有可能会取到两个过于近的点

### 2020-05-11
- HDMAPMDK-1122
  道路边缘线缺失问题没有复现，决定不再花时间调研原因
- 代谢增长论半小时
- Visitor重构使得它支持同起点终点的line
- 准备了一个面试题

### 2020-05-12
- 面试：两个候选人均不合格，思考如何快速甄别候选人，耗时3小时
- bugfix: HDMAPMDK-1211 删除错误border问题，在上次修复中没有修复成功
  有思路了但没写完
- 去健身了

### 2020-05-13
Bugfix: HDMAPMDK-1211 想到解法
- 根本原因是因为产线切分不合理

#### 原因分析
可以看到，在车道变道还没有结束时（车道中心线正在跨越车道线），就已经进行了切分，且这种切分是有可能跨越Rp的。

由于附着在lanecenter形状点上的lane border观测信息会忠实地根据几何，利用scan line的方式将两侧的车道线记录下来，没有根据语再过滤。因此在车道线跨越车道的位置，与车道线相交的车道中心线会将该车道线同时记录在左右lane border ref上

在现有的代码逻辑下，根据语义对相交车道线的border ref进行过滤时会根据车道变道类型推断出待删除的border ref

而当前逻辑在碰到这类切分的时候失效，从而导致这个问题。

#### 解法
核心点在于**找到相交车道线的变道趋势**，考虑到这类切分可能跨越rp，因此过滤不应当以rp为单位进行。

1. 首先将车道线利用edge lifting组织成path（可以为日后的graph重构考虑）: Seq[LaneCenter]
2. 找到待修正lane Center，以及待修正的lane border（这里假设这类lane Center一定是变道导致的）
3. 根据laneCenter path计算出该LaneCenter的变道趋势
4. 做过滤

交给了子良做

面试一人没过

### 2020-05-14
HDMAPMDK-1132 杆牌车道线端点的 id tracing

杆牌车道线端点面临的tracing问题相比较于线性object的tracing十分简单，只存在Id的映射，而没有offset和length的映射。

然而要考虑的问题也不少：
1. Procedure
2. Id Typing System是一个顽疾，需要想办法应对

本质上这个问题的根源在于，我们在定义Id的时候全部使用了Long Id，而MDM的定义中使用了Int，很有可能造成溢出问题。

### 2020-05-15
#### Bug修复
- HDMAPMDK-1215完成
- HDMAPMDK-1218 Done

### 2020-05-18
对OSM Assembler进行重构，使用了之前的OSM serialize，代码理解的难易度和编写的容易成都都有所提高

### 2020-05-19
解了一个OSM Assembler的bug，（其实也不算bug）

今天开了sprint planning会议：
本sprint要干的事情并不多，但是需要思考的事情很多。这是一个健康的状态

### 2020-05-20
- [ ] 写文档描述当前nexus/mdk CI状态，以及需求。
- [x] 关注HDMAPMDK-1263 bug
  - 确实是产线切分问题
- [ ] 约杨川会讨论CI
- [ ] HDMAPMDK-1262
  没干完
- [x] Custom Speed Limit的问题

### 2020-05-21
#### TODOs
- [x] 跟乔波打招呼
- [x] HDMAPMDK-1262
- [x] HDMAPMDK-755

#### Works
- 早上去镱铭工区在线debug昨天的hotfix，结果是因为offset的原因。昨天写的时候太仓促了，并且完全没有添加测试，这类行为不应该再发生。以为自己节省了很多时间，**结果却浪费了更多时间**。
- 1262拿不到数据的原因是MDK没有加载lane level的road mark（以及 road obstacle）
- 帮杜哥编译了数据

### 2020-05-22
这天我干啥了？？？？
我干啥了啊？？？？

### 2020-05-25
今天接到一个新任务：HDMAPMDK-1249-调研使用道路几何信息计算lane aggregation的方法。使得这周的任务变多了一些，截止目前我还有三件事要做：

1. 1249
2. 组内CI Pipeline的现状、需求和方案
3. Nexus graph重构

每一件事都是需要仔细构思并不轻松的事情，但遗憾的是我并不能针对每一件事情清楚地估计出时间来，都只是威宇预估好，写在jira任务的story points里面，有一点我很清楚：**如果我不开始估计和回顾，那我就永远也估计不准**。所以从这次开始要仔细估计。

另外我计划今天开始搞1249，因为是业务上的事情，一般来说会较为紧急一点，而且威宇也会更加在意这个，至于重构的事情的话，如果我自己不上心，那可能也没人会在意了（因为很残酷，不影响功能，却影响效率，而效率是最难以测量的，就连我自己也只有定性的分析）

### 2020-05-26
今天突发事情很多，先是parking报出了两个bug，原计划今天交付，因为这两个bug的原因就不能够今天交付了，王维跟下游商量推迟了两天到后天再交付，于是我这两天的主要工作又变成了解bug。让我不禁思考交付时候的排期是否合理。然后是HDMAPMDK-1290的问题。

今天完成的事情：
- HDMAPMDK-1290的后续：在极其接近stop line的时候match的lane offset会比lane length更长
  > 花了一整天的时间去调研并想办法解决这个问题（目前时间晚上8:56），效率非常低。
  
  其本质原因是MDK在计算长度时是计算每两个点的长度就取一个coordinate transform这样下来虽然会更准确，但是会使得结果有极强的不确定性。
  
  最后使用一个算是hack的办法：只要计算的offset比长度长，就只取长度。
- HDMAPMDK-1297 停车位绑定错
  虽然快要到原定的下班时间（晚上九点），我今天一定要至少把这个问题分析出来！
  害，搞定了。结果是个简单的问题

### 2020-05-27
今天不出意外的话要做完CI Pipeline的事情

结果出意外了- -

收到逸铭反馈的bug：
1. 红绿灯绑定：本应该绑定在待转区的红绿灯绑定在了待转区前的partition上了，已经修复(1.5h)
2. 红绿灯漏绑定：没复现出来
  更新：经过一轮艰难的debug，终于找到问题所在，是编译时rc与offset绑定时候用的geometry并不是同一根线，导致的offset超出road长度，所以找不到traffic light（2h）

### 2020-05-28
明天考科二，今天练车一天，下午5点才回来。感觉还不错，希望明天能过。

开始了CI Pipeline的现状描述和需求分析- -

### 2020-05-29
结果没过。害，我太难了。

早上去考试了，下午干了几件事情

1. 去逸铭那里看了一个异常情况，结果是两个bug。
2. 下午townhall完同步了一下MDK python binding的事情。
3. 和单乐威宇一起去楼下解决下游的问题，最后总结出一个短期方案一个长期方案。

我发现遇到一些突发的问题，一般来说解决问题的方法应该就是这个模式：
一个短期方案，一个长期方案。因为问题所暴露出来的价值是一定的，并且是有时效性的。因此短期方案着眼于快准狠地解决燃眉之急。那还需不需要长期方案了呢？一般来说是需要的，因为一个问题的特例反映了一类之前的没有考虑到的解决方案的盲点，这时候分析问题产生的原因并系统地解决它，使得这类问题以后都可以得到很好地解决，使得原先的解决方案更加完整。不需要长期方案的情况也有，那就是这个问题**在彻底地分析之后**我们判断得到结论：系统地解决这个问题的代价要比收益高。（即使是这样，大多数情况下我们主观上还是想去系统地解决它的，作为一个工程师谁不希望系统地解决问题呢？但这也就留下了一个陷阱，使得人有可能去解决那些重要不紧急的事情，或者既不重要也不紧急的事情，从而浪费了本可以用来解决其他更有价值的问题的宝贵时间。）

4. 晚上回来继续搞CI Pipeline的事情。