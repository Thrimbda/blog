---
"title": "Worktileã®è¦æ±‚ç®¡ç†å®ŸåŠ›åˆ†æ"
"summary": "æœ¬ç¨¿ã¯ã€äººæœˆã®ç¥è©±ã€ã«ãŠã‘ã‚‹ãƒãƒ™ãƒ«ã®å¡”ã®å¤±æ•—äº‹ä¾‹ã‹ã‚‰å§‹ã‚ã€è¦æ±‚ç®¡ç†ã®å¤±æ•—åŸå› ã¯ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®æ¬ å¦‚ã€çµ„ç¹”åŒ–ã®æ¬ å¦‚ã€ã‚·ã‚¹ãƒ†ãƒ ç¯„å›²ã®éå¤§ã•ã«ã‚ã‚‹ã¨æŒ‡æ‘˜ã—ã¾ã™ã€‚ç¶šã„ã¦ã€Worktileãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç®¡ç†ãƒ„ãƒ¼ãƒ«ã®ç‰¹å¾´ã€ã™ãªã‚ã¡ã‚«ãƒ³ãƒãƒ³å¼ã‚¿ã‚¹ã‚¯ç®¡ç†ã€ãƒ•ã‚¡ã‚¤ãƒ«åŒæœŸã€å…±æœ‰ãƒãƒ¼ãƒ ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€šçŸ¥ã€åˆ†æçµ±è¨ˆãƒ“ãƒ¥ãƒ¼ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚ãã®å¾Œã€Worktileã‚’ç”¨ã„ãŸè¦æ±‚ç®¡ç†ã®ãƒ—ãƒ­ã‚»ã‚¹ï¼ˆè¦æ±‚æå‡ºã€å¯©æŸ»ã€å®Ÿæ–½ã€ç¢ºèªã€æ¸¬å®šï¼‰ã‚’è©³ç´°ã«èª¬æ˜ã—ã€WorktileãŒã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆã€ãƒ©ãƒ™ãƒ«ã€å„ªå…ˆåº¦ã€çµ±è¨ˆåˆ†æã‚’é€šã˜ã¦è¦æ±‚ç®¡ç†ã®å•é¡Œã‚’ã©ã®ã‚ˆã†ã«è§£æ±ºã™ã‚‹ã‹ã‚’ç¤ºã—ã¾ã™ã€‚æœ€å¾Œã«ã€WorktileãŒè¦æ±‚ç®¡ç†ã€äººå“¡çµ„ç¹”ã€ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãªã©ã®å•é¡Œã‚’è§£æ±ºã§ãã‚‹ã¨çµè«–ã¥ã‘ã€è¦æ±‚ç®¡ç†ã¯ä»–ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç®¡ç†è¦ç´ ã¨çµ„ã¿åˆã‚ã›ã‚‹ã¹ãã§ã‚ã‚‹ã¨å¼·èª¿ã—ã¦ã„ã¾ã™ã€‚"
"tags":
  - "è¦æ±‚ç®¡ç†"
  - "Worktile"
  - "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç®¡ç†"
  - "ã‚·ã‚¹ãƒ†ãƒ åˆ†æ"
  - "ã‚¿ã‚¹ã‚¯ã‚³ãƒ©ãƒœãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³"
  - "ã‚«ãƒ³ãƒãƒ³"
  - "ãƒãƒ¼ãƒ ã‚³ãƒ©ãƒœãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³"
  - "è¦æ±‚åˆ†æ"
"date": "2017-04-06"
---

---
title: Worktileã®è¦æ±‚ç®¡ç†å®ŸåŠ›åˆ†æ
date: 2017-04-06
taxonomies:
  tags:
    - è¦æ±‚åˆ†æ
    - ã‚·ã‚¹ãƒ†ãƒ åˆ†æã¨è¨­è¨ˆ
---

# è¦æ±‚ç®¡ç†

ã¾ãšã€ã€äººæœˆã®ç¥è©±ã€ã‹ã‚‰ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç®¡ç†ã«é–¢ã™ã‚‹å…¸å‹çš„ãªå¤±æ•—ä¾‹ã‚’ä¸€éƒ¨æŠœç²‹ã—ã¾ã™ã€‚

<!--more-->

> **ãƒãƒ™ãƒ«ã®å¡”ã®ç®¡ç†æ•™è¨“**
>
> ã€å‰µä¸–è¨˜ã€ã«ã‚ˆã‚Œã°ã€ãƒãƒ™ãƒ«ã®å¡”ã¯ãƒã‚¢ã®ç®±èˆŸã«æ¬¡ãäººé¡ç¬¬äºŒã®å¤§å·¥äº‹ã§ã—ãŸãŒã€åŒæ™‚ã«æœ€åˆã®å®Œå…¨ãªå¤±æ•—å·¥äº‹ã§ã‚‚ã‚ã‚Šã¾ã—ãŸã€‚
>
> ã“ã®ç‰©èªã¯å¤šãã®ç‚¹ã§ã€ã•ã¾ã–ã¾ãªãƒ¬ãƒ™ãƒ«ã«ãŠã„ã¦éå¸¸ã«ç¤ºå”†ã«å¯Œã¿ã€æ•™è‚²çš„ã§ã™ã€‚ç´”ç²‹ãªå·¥äº‹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¨ã—ã¦æ‰ãˆã€ç®¡ç†é¢ã§å­¦ã¶ã¹ãæ•™è¨“ã¯ä½•ã‹ã‚’è¦‹ã¦ã¿ã¾ã—ã‚‡ã†ã€‚ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®å‰ææ¡ä»¶ã¯ã©ã‚Œã»ã©è‰¯ã‹ã£ãŸã®ã§ã—ã‚‡ã†ã‹ï¼Ÿå½¼ã‚‰ã¯ä»¥ä¸‹ã‚’æŒã£ã¦ã„ã¾ã—ãŸã‹ï¼š
>
> 1. æ˜ç¢ºãªç›®æ¨™ï¼Ÿ
>
>    ã¯ã„ã€‚ä¸å¯èƒ½ã«è¿‘ã„ã»ã©å¹¼ç¨šã§ã¯ã‚ã‚Šã¾ã—ãŸãŒã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯ã“ã®åŸºæœ¬çš„ãªåˆ¶é™ã«ç›´é¢ã™ã‚‹ã¯ã‚‹ã‹å‰ã«å¤±æ•—ã—ã¦ã„ã¾ã—ãŸã€‚
>
> 2. äººçš„è³‡æºï¼Ÿ
>
>    éå¸¸ã«è±Šå¯Œã§ã—ãŸã€‚
>
> 3. ææ–™ï¼Ÿ
>
>    ãƒ¡ã‚½ãƒã‚¿ãƒŸã‚¢ã«ã¯è±Šå¯ŒãªåœŸã¨ã‚¢ã‚¹ãƒ•ã‚¡ãƒ«ãƒˆãŒã‚ã‚Šã¾ã—ãŸã€‚
>
> 4. ååˆ†ãªæ™‚é–“ï¼Ÿ
>
>    ã¯ã„ã€‚æ™‚é–“åˆ¶é™ã®å…†å€™ã¯ä¸€åˆ‡ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚
>
> 5. ååˆ†ãªæŠ€è¡“ï¼Ÿ
>
>    ã¯ã„ã€‚ãƒ”ãƒ©ãƒŸãƒƒãƒ‰ã¾ãŸã¯å††éŒå½¢ã®æ§‹é€ è‡ªä½“ãŒå®‰å®šã—ã¦ãŠã‚Šã€åœ§åŠ›è² è·ã‚’ã†ã¾ãåˆ†æ•£ã§ãã¾ã™ã€‚ç…‰ç“¦å»ºç¯‰æŠ€è¡“ã«ã¤ã„ã¦ã‚‚ã€äººã€…ã¯æ·±ãç ”ç©¶ã—ã¦ã„ã¾ã—ãŸã€‚åŒæ§˜ã«ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯æŠ€è¡“çš„é™ç•Œã«é”ã™ã‚‹ã¯ã‚‹ã‹å‰ã«å¤±æ•—ã—ã¦ã„ã¾ã—ãŸã€‚
>
> ã§ã¯ã€ã“ã‚Œã‚‰ã™ã¹ã¦ã®æ¡ä»¶ã‚’å‚™ãˆã¦ã„ãŸã®ã«ã€ãªãœãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯å¤±æ•—ã—ãŸã®ã§ã—ã‚‡ã†ã‹ï¼Ÿå½¼ã‚‰ã«æ¬ ã‘ã¦ã„ãŸã‚‚ã®ã¯ä½•ã§ã—ã‚‡ã†ã‹ï¼ŸäºŒã¤ã®å´é¢ã§ã™â€”â€”**ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³**ã€ãã—ã¦ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®çµæœã¨ã—ã¦ã®**çµ„ç¹”åŒ–**ã§ã™ã€‚å½¼ã‚‰ã¯äº’ã„ã«è©±ã™ã“ã¨ãŒã§ããšã€å”åŠ›ã™ã‚‹ã“ã¨ãŒã§ãã¾ã›ã‚“ã§ã—ãŸã€‚å”åŠ›ãŒé€²ã¾ãªã„ã¨ã€ä½œæ¥­ã¯åœæ»ã—ã¾ã—ãŸã€‚å²æ›¸ã®è¡Œé–“ã‹ã‚‰æ¨æ¸¬ã™ã‚‹ã¨ã€ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®æ¬ å¦‚ãŒè«–äº‰ã€æ¬²æ±‚ä¸æº€ã€é›†å›£çŒœç–‘å¿ƒã‚’å¼•ãèµ·ã“ã—ã¾ã—ãŸã€‚ã™ãã«ã€éƒ¨æ—ã¯åˆ†è£‚ã—å§‹ã‚ã¾ã—ãŸâ€”â€” äººã€…ã¯äº’ã„ã«äº‰ã†ã‚ˆã‚Šã‚‚å­¤ç«‹ã‚’é¸ã‚“ã ã®ã§ã™ã€‚

è‘—è€…ã¯åˆ†æã®çµæœã€ã“ã®å¤±æ•—ã—ãŸãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®åŸå› ãŒä»¥ä¸‹ã®ç‚¹ã«ã‚ã‚‹ã¨ã—ã¦ã„ã¾ã™ï¼š

- ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒå–ã‚Œãªã„
# 1. æ¦‚è¿°

æœ¬æ–‡ï¼Œæˆ‘ä»¬æ¥åˆ†äº« MyBatis çš„æ—¥å¿—æ¨¡å—ï¼Œå¯¹åº” `logging` åŒ…ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š[![`logging` åŒ…](http://static.iocoder.cn/images/MyBatis/2020_01_07/01.png)](http://static.iocoder.cn/images/MyBatis/2020_01_07/01.png)`logging` åŒ…

åœ¨ [ã€Šç²¾å°½ MyBatis æºç è§£æ â€”â€” é¡¹ç›®ç»“æ„ä¸€è§ˆã€‹](http://svip.iocoder.cn/MyBatis/intro) ä¸­ï¼Œç®€å•ä»‹ç»äº†è¿™ä¸ªæ¨¡å—å¦‚ä¸‹ï¼š

> æ— è®ºåœ¨å¼€å‘æµ‹è¯•ç¯å¢ƒä¸­ï¼Œè¿˜æ˜¯åœ¨çº¿ä¸Šç”Ÿäº§ç¯å¢ƒä¸­ï¼Œæ—¥å¿—åœ¨æ•´ä¸ªç³»ç»Ÿä¸­çš„åœ°ä½éƒ½æ˜¯éå¸¸é‡è¦çš„ã€‚è‰¯å¥½çš„æ—¥å¿—åŠŸèƒ½å¯ä»¥å¸®åŠ©å¼€å‘äººå‘˜å’Œæµ‹è¯•äººå‘˜å¿«é€Ÿå®šä½ Bug ä»£ç ï¼Œä¹Ÿå¯ä»¥å¸®åŠ©è¿ç»´äººå‘˜å¿«é€Ÿå®šä½æ€§èƒ½ç“¶é¢ˆç­‰é—®é¢˜ã€‚ç›®å‰çš„ Java ä¸–ç•Œä¸­å­˜åœ¨å¾ˆå¤šä¼˜ç§€çš„æ—¥å¿—æ¡†æ¶ï¼Œä¾‹å¦‚ Log4jã€ Log4j2ã€Apache Commons Logã€java.util.loggingã€slf4j ç­‰ã€‚
>
> MyBatis ä½œä¸ºä¸€ä¸ªè®¾è®¡ä¼˜è‰¯çš„æ¡†æ¶ï¼Œé™¤äº†æä¾›è¯¦ç»†çš„æ—¥å¿—è¾“å‡ºä¿¡æ¯ï¼Œè¿˜è¦èƒ½å¤Ÿé›†æˆå¤šç§æ—¥å¿—æ¡†æ¶ï¼Œå…¶æ—¥å¿—æ¨¡å—çš„ä¸€ä¸ªä¸»è¦åŠŸèƒ½å°±æ˜¯**é›†æˆç¬¬ä¸‰æ–¹æ—¥å¿—æ¡†æ¶**ã€‚

æœ¬æ–‡æ¶‰åŠçš„ç±»å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<img src="http://ahaolin-public-img.oss-cn-hangzhou.aliyuncs.com/img/202201141000201.png" alt="img" style="zoom:150%;" />

- ä»å›¾çš„**å³ä¸Šè§’**ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° MyBatis ç›´æ¥é›†æˆäº†å¾ˆå¤šç¬¬ä¸‰æ–¹çš„æ—¥å¿—æ¡†æ¶ã€‚
- ä»å›¾çš„**å·¦ä¸‹è§’**ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°æœ‰ä¸€ä¸ª Jdk çš„æ—¥å¿—æ¡†æ¶ï¼Œè¿˜æœ‰ä¸€ä¸ª `stderr` æ ‡å‡†è¾“å…¥è¾“å‡ºã€‚ğŸ˜ˆ å®é™…ä¸Šï¼Œ`stderr` ä¸ç®—ä¸€ä¸ªæ—¥å¿—æ¡†æ¶ï¼Œä»…ä»…å½“æ— æ³•æ‰¾åˆ°ç¬¬ä¸‰æ–¹æ—¥å¿—æ¡†æ¶æ—¶ï¼Œä¼šä½¿ç”¨å®ƒæ¥æ‰“å°æ—¥å¿—ã€‚
- ä»å›¾çš„**ä¸­é—´**ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° `slf4j` è¿™ä¸ªæ—¥å¿—é—¨é¢ã€‚å…³äºè¿™ä¸ªæ¦‚å¿µï¼Œä¸äº†è§£çš„èƒ–å‹ï¼Œå¯ä»¥ Google ä¸€ä¸‹ã€‚

ä¸‹é¢ï¼Œæˆ‘ä»¬æŒ‰ç…§å›¾çš„**å·¦ä¸Šè§’**åˆ°**å³ä¸‹è§’**çš„é¡ºåºï¼Œé€ä¸ªæ—¥å¿—æ¡†æ¶æ¥åˆ†äº«ã€‚

# 2. LogFactory

`org.apache.ibatis.logging.LogFactory` ï¼ŒLog å·¥å‚ç±»ã€‚

## 2.1 æ„é€ æ–¹æ³•

```java
// LogFactory.java

/**
 * Marker to be used by logging implementations that support markers
 */
public static final String MARKER = "MYBATIS";

/**
 * ä½¿ç”¨çš„ Log çš„æ„é€ æ–¹æ³•
 */
private static Constructor<? extends Log> logConstructor;

static {
    // <1> é€ä¸ªå°è¯•ï¼Œåˆ¤æ–­ä½¿ç”¨å“ªä¸ª Log çš„å®ç°ç±»ï¼Œå³åˆå§‹åŒ– logConstructor å±æ€§
    tryImplementation(LogFactory::useSlf4jLogging);
    tryImplementation(LogFactory::useCommonsLogging);
    tryImplementation(LogFactory::useLog4J2Logging);
    tryImplementation(LogFactory::useLog4JLogging);
    tryImplementation(LogFactory::useJdkLogging);
    tryImplementation(LogFactory::useNoLogging);
}
```

- `<1>` å¤„ï¼Œåœ¨ç±»çš„é™æ€ä»£ç å—ä¸­ï¼Œä¼šæŒ‰ç…§ `slf4j` -> `commonsLogging` -> `log4j2` -> `log4j` -> `jdkLogging` -> `noLogging` çš„é¡ºåºï¼Œé€ä¸ªå°è¯•ï¼Œåˆ¤æ–­ä½¿ç”¨å“ªä¸ª Log çš„å®ç°ç±»ï¼Œå³åˆå§‹åŒ– `logConstructor` å±æ€§ã€‚

- `#tryImplementation(Runnable runnable)` æ–¹æ³•ï¼Œå°è¯•è°ƒç”¨æ–¹æ³•ï¼Œå¦‚æœæˆåŠŸï¼Œåˆ™ä¸å†å°è¯•ã€‚ä»£ç å¦‚ä¸‹ï¼š

  ```java
  // LogFactory.java
  
  private static void tryImplementation(Runnable runnable) {
      if (logConstructor == null) {
          try {
              runnable.run();
          } catch (Throwable t) {
              // ignore
          }
      }
  }
  ```

- `#useXXXLogging()` æ–¹æ³•ï¼Œå°è¯•ä½¿ç”¨å¯¹åº”çš„ Log çš„å®ç°ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š

  ```java
  // LogFactory.java
  
  public static synchronized void useSlf4jLogging() {
      setImplementation(org.apache.ibatis.logging.slf4j.Slf4jImpl.class);
  }
  
  public static synchronized void useCommonsLogging() {
      setImplementation(org.apache.ibatis.logging.commons.JakartaCommonsLoggingImpl.class);
  }
  
  public static synchronized void useLog4JLogging() {
      setImplementation(org.apache.ibatis.logging.log4j.Log4jImpl.class);
  }
  
  public static synchronized void useLog4J2Logging() {
      setImplementation(org.apache.ibatis.logging.log4j2.Log4j2Impl.class);
  }
  
  public static synchronized void useJdkLogging() {
      setImplementation(org.apache.ibatis.logging.jdk14.Jdk14LoggingImpl.class);
  }
  
  public static synchronized void useStdOutLogging() {
      setImplementation(org.apache.ibatis.logging.stdout.StdOutImpl.class);
  }
  
  public static synchronized void useNoLogging() {
      setImplementation(org.apache.ibatis.logging.nologging.NoLoggingImpl.class);
  }
  ```

  - æ¯ä¸ªæ–¹æ³•ï¼Œéƒ½è°ƒç”¨äº† `#setImplementation(Class<? extends Log> implClass)` æ–¹æ³•ï¼Œå°è¯•åˆå§‹åŒ– `logConstructor` å±æ€§ã€‚ä»£ç å¦‚ä¸‹ï¼š

    ```java
    // LogFactory.java
    
    private static void setImplementation(Class<? extends Log> implClass) {
        try {
            // è·å¾—å‚æ•°ä¸º String çš„æ„é€ æ–¹æ³•
            Constructor<? extends Log> candidate = implClass.getConstructor(String.class);
            // åˆ›å»º Log å¯¹è±¡
            Log log = candidate.newInstance(LogFactory.class.getName());
            if (log.isDebugEnabled()) {
                log.debug("Logging initialized using '" + implClass + "' adapter.");
            }
            // åˆ›å»ºæˆåŠŸï¼Œæ„å‘³ç€å¯ä»¥ä½¿ç”¨ï¼Œè®¾ç½®ä¸º logConstructor
            logConstructor = candidate;
        } catch (Throwable t) {
            throw new LogException("Error setting Log implementation.  Cause: " + t, t);
        }
    }
    ```

    - åœ¨è¯¥æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒLog çš„å®ç°ç±»ï¼Œéœ€è¦æœ‰ä¸€ä¸ªå‚æ•°ä¸º `String.class` çš„æ„é€ æ–¹æ³•ã€‚ä¾‹å¦‚ï¼Œ`org.apache.ibatis.logging.slf4j.Slf4jImpl` çš„æ„é€ æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š

      ```java
      // Slf4jImpl.java
      
      public Slf4jImpl(String clazz) {
          Logger logger = LoggerFactory.getLogger(clazz);
      
          if (logger instanceof LocationAwareLogger) {
              try {
                  // check for slf4j >= 1.6 method signature
                  logger.getClass().getMethod("log", Marker.class, String.class, int.class, String.class, Object[].class, Throwable.class);
                  log = new Slf4jLocationAwareLoggerImpl((LocationAwareLogger) logger);
                  return;
              } catch (SecurityException e) {
                  // fail-back to Slf4jLoggerImpl
              } catch (NoSuchMethodException e) {
                  // fail-back to Slf4jLoggerImpl
              }
          }
      
          // Logger is not LocationAwareLogger or slf4j version < 1.6
          log = new Slf4jLoggerImpl(logger);
      }
      ```

      - é€šè¿‡è¿™æ ·çš„æ–¹å¼ï¼Œåˆ›å»ºäº† `log` å±æ€§ã€‚åç»­ï¼Œåœ¨ Slf4jImpl ä¸­ï¼Œä¼šä½¿ç”¨è¯¥ `log` å±æ€§ï¼Œæ‰“å°æ—¥å¿—ã€‚

## 2.2 getLog

`#getLog(...)` æ–¹æ³•ï¼Œè·å¾— Log å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š

```java
// LogFactory.java

public static Log getLog(Class<?> aClass) {
    return getLog(aClass.getName());
}

public static Log getLog(String logger) {
    try {
        return logConstructor.newInstance(logger);
    } catch (Throwable t) {
        throw new LogException("Error creating logger for logger " + logger + ".  Cause: " + t, t);
    }
}
```

- é€šè¿‡è°ƒç”¨ `logConstructor` çš„æ„é€ æ–¹æ³•ï¼Œåˆ›å»º Log å¯¹è±¡ã€‚

## 2.3 å°ç»“

LogFactory è´Ÿè´£åˆ›å»º Log å¯¹è±¡ã€‚ä½†æ˜¯å®é™…ä¸Šï¼Œå®ƒå†…éƒ¨ç®¡ç†çš„æ˜¯ Log å®ç°ç±»çš„æ„é€ æ–¹æ³•ã€‚å¹¶ä¸”ï¼Œé€šè¿‡ `tryImplementation` æ–¹æ³•ï¼Œå®ç°æŒ‰ç…§ `slf4j` -> `commonsLogging` -> `log4j2` -> `log4j` -> `jdkLogging` -> `noLogging` çš„é¡ºåºï¼Œå°è¯•ä½¿ç”¨å¯¹åº”çš„ Log çš„å®ç°ç±»ã€‚

# 3. Log

`org.apache.ibatis.logging.Log` ï¼ŒMyBatis Log æ¥å£ã€‚ä»£ç å¦‚ä¸‹ï¼š

```java
// Log.java

public interface Log {

    boolean isDebugEnabled();

    boolean isTraceEnabled();

    void error(String s, Throwable e);

    void error(String s);

    void debug(String s);

    void trace(String s);

    void warn(String s);

}
```

- å’Œä¸»æµçš„æ—¥å¿—æ¡†æ¶çš„æ¥å£ï¼ŒåŸºæœ¬ä¸€è‡´ã€‚

## 3.1 å„å®ç°ç±»

Log çš„å®ç°ç±»ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š[![Log çš„å®ç°ç±»](http://static.iocoder.cn/images/MyBatis/2020_01_07/02.png)](http://static.iocoder.cn/images/MyBatis/2020_01_07/02.png)Log çš„å®ç°ç±»

- æ¯ä¸ªå®ç°ç±»ï¼Œå¯¹åº”ä¸€ä¸ªç¬¬ä¸‰æ–¹çš„æ—¥å¿—æ¡†æ¶ã€‚æ‰€ä»¥ï¼Œæ¯ä¸ªå®ç°ç±»çš„ä»£ç ï¼Œéƒ½æ˜¯éå¸¸ç›¸ä¼¼çš„ã€‚ğŸ˜ˆ æ‰€ä»¥ï¼Œæˆ‘ä»¬ä»…ä»…é€‰æ‹© `slf4j` åŒ…ä¸‹çš„å®ç°ç±»ï¼Œè¿›è¡Œåˆ†äº«ã€‚

## 3.2 Slf4jImpl

`org.apache.ibatis.logging.slf4j.Slf4jImpl` ï¼Œå®ç° Log æ¥å£ï¼ŒSLF4J å®ç°ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š

```java
// Slf4jImpl.java

public class Slf4jImpl implements Log {

    /**
     * SLF4J Logger å¯¹è±¡
     */
    private Log log;

    public Slf4jImpl(String clazz) {
        // è·å¾— Logger å¯¹è±¡
        Logger logger = LoggerFactory.getLogger(clazz);

        // å¦‚æœä½¿ç”¨ LocationAwareLogger ï¼Œåˆ™åˆ›å»º Slf4jLocationAwareLoggerImpl å¯¹è±¡
        if (logger instanceof LocationAwareLogger) {
            try {
                // check for slf4j >= 1.6 method signature
                // é¦–å…ˆï¼Œæ£€æŸ¥æ˜¯å¦å­˜åœ¨ `log(Marker marker, String fqcn, int level, String message, Object[] argArray, Throwable t)` æ–¹æ³•ã€‚å¦‚æœæœ‰ï¼Œåˆ™æ„å‘³ç€å¯ä»¥ä½¿ç”¨ LocationAwareLogger å¯¹è±¡ã€‚å®é™…ä¸Šï¼Œè¿™é‡Œä½¿ç”¨äº†æ¡¥æ¥æ¨¡å¼ï¼ŒSlf4jLocationAwareLoggerImpl å®ç° Log æ¥å£ï¼Œå†…éƒ¨ç»„åˆ LocationAwareLogger å¯¹è±¡ã€‚
                logger.getClass().getMethod("log", Marker.class, String.class, int.class, String.class, Object[].class, Throwable.class);
                log = new Slf4jLocationAwareLoggerImpl((LocationAwareLogger) logger);
                return;
            } catch (SecurityException e) {
                // fail-back to Slf4jLoggerImpl
            } catch (NoSuchMethodException e) {
                // fail-back to Slf4jLoggerImpl
            }
        }

        // å¦åˆ™ï¼Œåˆ›å»º Slf4jLoggerImpl å¯¹è±¡
        // Logger is not LocationAwareLogger or slf4j version < 1.6
        log = new Slf4jLoggerImpl(logger);
    }

    @Override
    public boolean isDebugEnabled() {
        return log.isDebugEnabled();
    }

    @Override
    public boolean isTraceEnabled() {
        return log.isTraceEnabled();
    }

    @Override
    public void error(String s, Throwable e) {
        log.error(s, e);
    }

    @Override
    public void error(String s) {
        log.error(s);
    }

    @Override
    public void debug(String s) {
        log.debug(s);
    }

    @Override
    public void trace(String s) {
        log.trace(s);
    }

    @Override
    public void warn(String s) {
        log.warn(s);
    }

}
```

- åœ¨æ„é€ æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œæ ¹æ®ä¸åŒçš„æƒ…å†µï¼Œåˆ›å»º `log` ä¸º Slf4jLocationAwareLoggerImpl æˆ– Slf4jLoggerImpl å¯¹è±¡ã€‚é‚£ä¹ˆï¼Œè¿™ä¸¤ä¸ªç±»çš„åŒºåˆ«æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿç­”æ¡ˆåœ¨ä»£ç çš„æ³¨é‡Šä¸Šã€‚å› ä¸º `slf4j` æœ‰ `1.6` çš„ç‰ˆæœ¬å·®å¼‚ï¼Œæ‰€ä»¥è¦åšè¿™æ ·çš„å¤„ç†ã€‚ğŸ˜ˆ ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¸ä¼šä½¿ç”¨åˆ° `1.6` è¿™ä¹ˆè€çš„ç‰ˆæœ¬ï¼Œæ‰€ä»¥å¯ä»¥å¿½ç•¥ Slf4jLocationAwareLoggerImpl ç±»ã€‚
- åœ¨æ–¹æ³•ä¸­ï¼Œè°ƒç”¨ `log` å¯¹åº”çš„æ–¹æ³•ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒSlf4jImpl æ˜¯å¯¹ `log` çš„ä»£ç†ã€‚é‚£ä¹ˆï¼Œä¸ºä»€ä¹ˆè¦è¿™ä¹ˆåšå‘¢ï¼Ÿå› ä¸ºï¼ŒSlf4jImpl éœ€è¦åš `1.6` çš„ç‰ˆæœ¬å…¼å®¹ã€‚

### 3.2.1 Slf4jLoggerImpl

`org.apache.ibatis.logging.slf4j.Slf4jLoggerImpl` ï¼Œå®ç° Log æ¥å£ï¼Œ`slf4j` **(< 1.6)** å®ç°ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š

```java
// Slf4jLoggerImpl.java

public class Slf4jLoggerImpl implements Log {

    /**
     * SLF4J Logger å¯¹è±¡
     */
    private Logger log;

    public Slf4jLoggerImpl(Logger logger) {
        log = logger;
    }

    @Override
    public boolean isDebugEnabled() {
        return log.isDebugEnabled();
    }

    @Override
    public boolean isTraceEnabled() {
        return log.isTraceEnabled();
    }

    @Override
    public void error(String s, Throwable e) {
        log.error(s, e);
    }

    @Override
    public void error(String s) {
        log.error(s);
    }

    @Override
    public void debug(String s) {
        log.debug(s);
    }

    @Override
    public void trace(String s) {
        log.trace(s);
    }

    @Override
    public void warn(String s) {
        log.warn(s);
    }

}
```

- åœ¨æ–¹æ³•ä¸­ï¼Œè°ƒç”¨ `log` å¯¹åº”çš„æ–¹æ³•ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒSlf4jLoggerImpl æ˜¯å¯¹ `log` çš„ä»£ç†ã€‚é‚£ä¹ˆï¼Œä¸ºä»€ä¹ˆè¦è¿™ä¹ˆåšå‘¢ï¼Ÿå› ä¸ºï¼ŒSlf4jLoggerImpl éœ€è¦åš `1.6` çš„ç‰ˆæœ¬å…¼å®¹ã€‚

### 3.2.2 Slf4jLocationAwareLoggerImpl

`org.apache.ibatis.logging.slf4j.Slf4jLocationAwareLoggerImpl` ï¼Œå®ç° Log æ¥å£ï¼Œ`slf4j` **(>= 1.6)** å®ç°ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š

```java
// Slf4jLocationAwareLoggerImpl.java

public class Slf4jLocationAwareLoggerImpl implements Log {

    /**
     * SLF4J LocationAwareLogger å¯¹è±¡
     */
    private static final Marker MARKER = MarkerFactory.getMarker(LogFactory.MARKER);

    /**
     * LocationAwareLogger å¯¹è±¡
     */
    private static final String FQCN = Slf4jImpl.class.getName();

    /**
     * LocationAwareLogger å¯¹è±¡
     */
    private LocationAwareLogger logger;

    public Slf4jLocationAwareLoggerImpl(LocationAwareLogger logger) {
        this.logger = logger;
    }

    @Override
    public boolean isDebugEnabled() {
        return logger.isDebugEnabled();
    }

    @Override
    public boolean isTraceEnabled() {
        return logger.isTraceEnabled();
    }

    @Override
    public void error(String s, Throwable e) {
        logger.log(MARKER, FQCN, LocationAwareLogger.ERROR_INT, s, null, e);
    }

    @Override
    public void error(String s) {
        logger.log(MARKER, FQCN, LocationAwareLogger.ERROR_INT, s, null, null);
    }

    @Override
    public void debug(String s) {
        logger.log(MARKER, FQCN, LocationAwareLogger.DEBUG_INT, s, null, null);
    }

    @Override
    public void trace(String s) {
        logger.log(MARKER, FQCN, LocationAwareLogger.TRACE_INT, s, null, null);
    }

    @Override
    public void warn(String s) {
        logger.log(MARKER, FQCN, LocationAwareLogger.WARN_INT, s, null, null);
    }

}
```

- åœ¨æ–¹æ³•ä¸­ï¼Œè°ƒç”¨ `logger` å¯¹åº”çš„æ–¹æ³•ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒSlf4jLocationAwareLoggerImpl æ˜¯å¯¹ `logger` çš„ä»£ç†ã€‚é‚£ä¹ˆï¼Œä¸ºä»€ä¹ˆè¦è¿™ä¹ˆåšå‘¢ï¼Ÿå› ä¸ºï¼ŒSlf4jLocationAwareLoggerImpl éœ€è¦åš `1.6` çš„ç‰ˆæœ¬å…¼å®¹ã€‚

# 4. æ—¥å¿—æ‰“å°

åœ¨ MyBatis ä¸­ï¼Œæ—¥å¿—çš„æ‰“å°ï¼Œä¸»è¦ä½¿ç”¨ `BaseJdbcLogger`ã€`ConnectionLogger`ã€`StatementLogger`ã€`PreparedStatementLogger`ã€`ResultSetLogger` ç­‰ç­‰ã€‚ä½†æ˜¯ï¼Œå®é™…ä¸Šï¼Œæˆ‘ä»¬ä¼šå‘ç°ï¼Œåœ¨ `logging` åŒ…ä¸‹ï¼Œè¿˜æœ‰ `jdbc` åŒ…ã€‚ğŸ˜ˆ æ‰€ä»¥ï¼Œæœ¬æ–‡æš‚æ—¶ä¸åˆ†äº«è¿™å—å†…å®¹ï¼Œæ”¾åœ¨åé¢ï¼Œæˆ‘ä»¬çœ‹å…·ä½“ä»£ç çš„æ—¶å€™ï¼Œè¯¦ç»†è§£æã€‚

# 5. å¼‚å¸¸å¤„ç†

åœ¨ `logging` åŒ…ä¸‹ï¼Œè¿˜æœ‰ `LogException` å¼‚å¸¸ç±»ï¼Œè¢« `LogFactory` æ‰€ä½¿ç”¨ã€‚ä»£ç å¦‚ä¸‹ï¼š

```java
// LogException.java

public class LogException extends RuntimeException {

    private static final long serialVersionUID = 1022924004852350942L;

    public LogException() {
        super();
    }

    public LogException(String message) {
        super(message);
    }

    public LogException(String message, Throwable cause) {
        super(message, cause);
    }

    public LogException(Throwable cause) {
        super(cause);
    }

}
```

# 6. æ€»ç»“

ğŸ˜ˆ æ—¥å¿—æ¨¡å—ï¼Œæ¯”è¾ƒç®€å•ï¼Œæ‰€ä»¥å†…å®¹ä¸å¤šã€‚