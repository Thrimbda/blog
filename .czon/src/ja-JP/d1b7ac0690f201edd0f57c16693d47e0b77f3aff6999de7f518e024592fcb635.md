---
"title": "新しいブログをいじくり回す：機核の「機組」をブログに移行した話"
"summary": "本記事では、著者が機核（Gcores）上の「機組」コンテンツを個人ブログに移行した技術的プロセスを詳細に紹介します。古いブログが依存関係の陳腐化により機能しなくなったことから始まり、新しいブログジェネレーターとしてZolaを選んだ理由を説明。APIを用いた機組データの取得、Markdown形式への変換処理、そしてHTML、CSS、JavaScriptを用いたスライド式画像ギャラリーのフロントエンド実装に焦点を当てています。著者は、フロントエンド開発における迅速なフィードバックループの楽しさを強調し、タッチ操作のRxJS実装についても共有しています。最後に、ブログを完全にコントロールできた満足感と、コードを書くことの純粋な喜びについてまとめています。内容は比較的浅いものの、プロセス自体に大きな達成感があったと述べています。"
"tags":
  - "ブログ"
  - "技術"
  - "フロントエンド開発"
  - "データスクレイピング"
  - "Zola"
  - "機核"
  - "RxJS"
  - "Markdown"
"date": "2024-06-18"
---

**この記事は、私の消え去らぬ童心から生まれました。**

4月、ある旅の途中で、私は強い衝動に駆られて旅行記を書きたいと思い、まず機核に投稿しました。そしていつもの習慣通り、Markdown形式に整理して自分のブログにも投稿しようとしました。

ところが編集を終えた後、ブログが壊れていることに気づいたのです。

## 以前のブログ

個人ブログを構築するブームは、大学3年生の時に私たちの学科で流行りました。7年前に書いた[この記事](czon://5221db5c2766ca0baade64eb4959a1c4fb1596bf1294c20de8af0c1448781374)（今読むと恥ずかしさで足の指が丸まるような内容です）が、私が最初にこのブログを構築した時の心境を紹介しています。

その理由は、まず自分に何かを書くことを促したかったからです。次に、学校では教えてくれない、最新の流行りの技術を組み合わせたエンジニアリングの実践をしたかったからです。そして、独自ドメインを持つことは本当にクールだと思いました。少なくとも私はそう感じていました。

当時の情景を再現してみましょう。

---

何か新しいことを少し学ぶと、興奮した気持ちで、考えたことをMarkdown形式のドキュメントに書き留めました。

書き終えた後、新しいブログをアップロードするために、いくつかのコマンドを粋に実行しました：

```shell
$ git add .
$ git commit -m "new blog! hahahaha"
$ git push origin master
```

それからワクワクしながらCIの画面を開きました。当時、CIはまだ比較的新しい概念で、DevOpsの考え方が提唱されてから数年しか経っていませんでした。CIのログページで、この記事を含むブログ全体が静的なhtmlサイトとして構築されるのを待ち、Travisが私の鍵を使ってビルド成果物をgitリポジトリにプッシュするのを待ち、Githubがビルド成果物を公開するのを待ちました。

最後に私のドメイン [https://blog.thrimbda.com](https://blog.thrimbda.com) にアクセスし、新しい記事がページの一番上に表示されているのを満足げに見つめました。

---

年月が経つにつれ、このプロセスは退屈なものになりました。退屈でありながらも継続的に機能し続け、ついにそれが機能しなくなる日が訪れたのです。

## 新しいブログ

4月末のある日、CIパイプラインを3回連続で再実行しましたが、すべて失敗しました。ログをざっと見ると、ビルドに使用されていたある依存関係が古すぎて、インターネット上から消えてしまったようでした。私は、この業界において7年という時間がいかに巨大なスパンであるかを痛感しました。風砂が城を壊し、海水が山々を飲み込むほどに長い時間です。

そこで、仕事の合間の「サボり時間」に、あまり面白くはない要件をもとに技術選定を行いました：**十分にシンプルで、十分に便利なもの。**

こうして新しいブログが誕生しました。慣例に従って紹介します：

- ジェネレーターとして [Zola](https://www.getzola.org/) を選択しました。
- 非常にシンプルですがなかなか良い見た目の[テーマ](https://github.com/Speyll/anemone)を見つけました。

旧ブログの代替として、この新しいブログは完成しました。

## 童心を忘れずにいじくり回す過程

おそらく十分に新しいからか、技術選定が十分にシンプルだったからか、あるいはフロントエンド作業のフィードバックループが十分に短いからかもしれません。さらに阿錚と一緒に仕事をしていると、自然とフロントエンドの知識が身につき、大学1年生の時にあまり真剣に学ばなかった知識の穴を埋めることができました。その結果、ブログをいじくり回す過程が再び面白くなってきたのです。

ほんの少し手を加えたCSSスタイルの修正、新しいgitcusの追加、コメント欄をgithubにホストする設定など。私は7年前の自分と意見が一致しました：コーディングとエンジニアリングをいじくり回すことは、やはり楽しいことです。それは労働の喜びであり、遊びの喜びです。

私はこの喜びの余韻に乗じて、（自己満足的に）機組をブログに移行した技術的プロセスについて詳しく話したいと思います。

<!--more-->

---

### データ

以前のある調査で、私は機核がクローラーに対して非常に友好的であることに気づいていました。そのデータインターフェースは非常に統一されており、表現力に富んでいます。例えば、私の機組を探索してみましょう：

![gcores-api-at-glance](https://0xc1.space/images/2024/06/18/gcores-api-at-glance.jpg)

このURLが機組データをリクエストするためのAPIであることがわかります。

```
https://www.gcores.com/gapi/v1/users/464460/recommend?talk-include=topic%2Cuser%2Chelpful%2Cpoll-options%2Crelated-content.radio%2Crelated-content.video%2Crelated-content.article%2Crelated-content.game%2Crelated-content.film%2Crelated-content.album%2Crelated-content.album-bundle%2Crelated-content.product%2Crelated-content.discussion&original-include=user%2Cdjs%2Ccategory&order-by=time&before=1718720726.986&fields[articles]=title%2Cdesc%2Cexcerpt%2Cis-published%2Cthumb%2Capp-cover%2Ccover%2Ccomments-count%2Clikes-count%2Cbookmarks-count%2Cis-verified%2Cpublished-at%2Coption-is-official%2Coption-is-focus-showcase%2Cduration%2Cdraft%2Caudit-draft%2Cuser%2Ccomments%2Ccategory%2Ctags%2Centries%2Centities%2Csimilarities%2Clatest-collection%2Ccollections%2Coperational-events%2Cportfolios%2Ccatalog-tags&fields[videos]=title%2Cdesc%2Cexcerpt%2Cis-published%2Cthumb%2Capp-cover%2Ccover%2Ccomments-count%2Clikes-count%2Cbookmarks-count%2Cis-verified%2Cpublished-at%2Coption-is-official%2Coption-is-focus-showcase%2Cduration%2Cdraft%2Caudit-draft%2Cuser%2Ccomments%2Ccategory%2Ctags%2Centries%2Centities%2Csimilarities%2Clatest-collection%2Ccollections%2Coperational-events%2Cportfolios%2Ccatalog-tags%2Cmedia%2Cdjs%2Calbums%2Cpublished-albums&fields[radios]=title%2Cdesc%2Cexcerpt%2Cis-published%2Cthumb%2Capp-cover%2Ccover%2Ccomments-count%2Clikes-count%2Cbookmarks-count%2Cis-verified%2Cpublished-at%2Coption-is-official%2Coption-is-focus-showcase%2Cduration%2Cdraft%2Caudit-draft%2Cuser%2Ccomments%2Ccategory%2Ctags%2Centries%2Centities%2Csimilarities%2Clatest-collection%2Ccollections%2Coperational-events%2Cportfolios%2Ccatalog-tags%2Cmedia%2Cdjs%2Clatest-album%2Calbums%2Cis-free%2Cis-require-privilege
```

#### 生データ

情報を整理してみましょう：

```ts
const user = 464460;

const url = new URL(
  `https://www.gcores.com/gapi/v1/users/${user}/recommend?talk-include=topic%2Cuser%2Chelpful%2Cpoll-options%2Crelated-content.radio%2Crelated-content.video%2Crelated-content.article%2Crelated-content.game%2Crelated-content.film%2Crelated-content.album%2Crelated-content.album-bundle%2Crelated-content.product%2Crelated-content.discussion&original-include=user%2Cdjs%2Ccategory&order-by=time&fields[articles]=title%2Cdesc%2Cexcerpt%2Cis-published%2Cthumb%2Capp-cover%2Ccover%2Ccomments-count%2Clikes-count%2Cbookmarks-count%2Cis-verified%2Cpublished-at%2Coption-is-official%2Coption-is-focus-showcase%2Cduration%2Cdraft%2Caudit-draft%2Cuser%2Ccomments%2Ccategory%2Ctags%2Centries%2Centities%2Csimilarities%2Clatest-collection%2Ccollections%2Coperational-events%2Cportfolios%2Ccatalog-tags&fields[videos]=title%2Cdesc%2Cexcerpt%2Cis-published%2Cthumb%2Capp-cover%2Ccover%2Ccomments-count%2Clikes-count%2Cbookmarks-count%2Cis-verified%2Cpublished-at%2Coption-is-official%2Coption-is-focus-showcase%2Cduration%2Cdraft%2Caudit-draft%2Cuser%2Ccomments%2Ccategory%2Ctags%2Centries%2Centities%2Csimilarities%2Clatest-collection%2Ccollections%2Coperational-events%2Cportfolios%2Ccatalog-tags%2Cmedia%2Cdjs%2Calbums%2Cpublished-albums&fields[radios]=title%2Cdesc%2Cexcerpt%2Cis-published%2Cthumb%2Capp-cover%2Ccover%2Ccomments-count%2Clikes-count%2Cbookmarks-count%2Cis-verified%2Cpublished-at%2Coption-is-official%2Coption-is-focus-showcase%2Cduration%2Cdraft%2Caudit-draft%2Cuser%2Ccomments%2Ccategory%2Ctags%2Centries%2Centities%2Csimilarities%2Clatest-collection%2Ccollections%2Coperational-events%2Cportfolios%2Ccatalog-tags%2Cmedia%2Cdjs%2Clatest-album%2Calbums%2Cis-free%2Cis-require-privilege`
);
```

さらに観察すると、ページネーションは `before` というパラメータで決定されているようです。このパラメータのタイムスタンプを前に進めながら、データが取得できなくなるまで繰り返せば良いのです。これにより、以下のようなコードが得られます：

```ts
import {
  EMPTY,
  Observable,
  expand,
  map,
  mergeAll,
  mergeMap,
  of,
  shareReplay,
  skip,
  takeWhile,
  tap,
  toArray,
} from "https://esm.sh/rxjs@7.8.1";

const user = 464460;

const url = new URL(
  `https://www.gcores.com/gapi/v1/users/${user}/recommend?talk-include=topic%2Cuser%2Chelpful%2Cpoll-options%2Crelated-content.radio%2Crelated-content.video%2Crelated-content.article%2Crelated-content.game%2Crelated-content.film%2Crelated-content.album%2Crelated-content.album-bundle%2Crelated-content.product%2Crelated-content.discussion&original-include=user%2Cdjs%2Ccategory&order-by=time&fields[articles]=title%2Cdesc%2Cexcerpt%2Cis-published%2Cthumb%2Capp-cover%2Ccover%2Ccomments-count%2Clikes-count%2Cbookmarks-count%2Cis-verified%2Cpublished-at%2Coption-is-official%2Coption-is-focus-showcase%2Cduration%2Cdraft%2Caudit-draft%2Cuser%2Ccomments%2Ccategory%2Ctags%2Centries%2Centities%2Csimilarities%2Clatest-collection%2Ccollections%2Coperational-events%2Cportfolios%2Ccatalog-tags&fields[videos]=title%2Cdesc%2Cexcerpt%2Cis-published%2Cthumb%2Capp-cover%2Ccover%2Ccomments-count%2Clikes-count%2Cbookmarks-count%2Cis-verified%2Cpublished-at%2Coption-is-official%2Coption-is-focus-showcase%2Cduration%2Cdraft%2Caudit-draft%2Cuser%2Ccomments%2Ccategory%2Ctags%2Centries%2Centities%2Csimilarities%2Clatest-collection%2Ccollections%2Coperational-events%2Cportfolios%2Ccatalog-tags%2Cmedia%2Cdjs%2Calbums%2Cpublished-albums&fields[radios]=title%2Cdesc%2Cexcerpt%2Cis-published%2Cthumb%2Capp-cover%2Ccover%2Ccomments-count%2Clikes-count%2Cbookmarks-count%2Cis-verified%2Cpublished-at%2Coption-is-official%2Coption-is-focus-showcase%2Cduration%2Cdraft%2Caudit-draft%2Cuser%2Ccomments%2Ccategory%2Ctags%2Centries%2Centities%2Csimilarities%2Clatest-collection%2Ccollections%2Coperational-events%2Cportfolios%2Ccatalog-tags%2Cmedia%2Cdjs%2Clatest-album%2Calbums%2Cis-free%2Cis-require-privilege`
);

const imageUrl = (image: string) =>
  `https://image.gcores.com/${image}?x-oss-process=image/quality,q_90/format,webp`;

// ページネーション
url.searchParams.set("before", `${Date.now() / 1000}`);

interface IGcoresTalk {
  text: string;
  images: string[];
  published_at: number;
  tags: string[];
}

const rawGcoresTalkData$: Observable<any[]> = of({
  before: Date.now() / 1000,
}).pipe(
  // 生データ
  expand(async ({ before }) => {
    url.searchParams.set("before", `${before}`);
    const res = await fetch(url);
    const data = await res.json();
    if (!data.data || data.data.length === 0) {
      return EMPTY;
    }
    return {
      before:
        new Date(
          data.data[data.data.length - 1].attributes["published-at"]
        ).getTime() / 1000,
      ...data,
    };
  }),
  skip(1),
  // デバッグ用
  // take(1),
  takeWhile((v) => !!v.data),
  // filter((v) => v.data.length > 0),
  tap((v) => {
    console.info(v);
  }),
  toArray(),
  shareReplay(1)
);
```

これで、あるユーザーのすべての機組生データを保持するrxストリームが得られました。

#### データ処理

生データが手に入ったので、次はMarkdownに変換します。直接処理を始めましょう。ポイントは以下の通りです：

- 表示する内容を決める
- 機核のインターフェースフィールドを理解する

機組は、SNSのタイムラインや微博と似ていて、文字と画像、それにいくつかのタグで構成されています。そのまま平たく表示することにしましょう。

機組のデータは以下のように定義できます：

```json
{
  "blocks": [
    {
      "data": { "spoiler": false },
      "depth": 0,
      "entityRanges": [{ "key": 0, "length":