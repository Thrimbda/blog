---
"title": "MapReduce 論文ノート"
"summary": "本稿はMapReduce論文に関するノートであり、MapReduceの起源、実装詳細、フォールトトレランス機構、および性能について詳細に述べています。記事では、MapReduceが大規模データ処理における並列計算、データ分散、フォールトトレランスといった課題を解決するために提案された抽象モデルであり、関数型プログラミングのMapとReduceの概念を借用していると指摘しています。実装部分では、実行ロジック、データ構造、フォールトトレランス処理が含まれており、Masterがタスクをスケジューリングし、WorkerがMapおよびReduce操作を実行し、バックアップタスクによって「落伍者」問題を解決します。性能テストでは、grepおよびソートタスクにおける効率性が示されています。まとめとして、MapReduceは確固たる基盤を持つ分散計算フレームワークであると結論づけています。"
"tags":
  - "MapReduce"
  - "分散システム"
  - "論文ノート"
  - "フォールトトレランス"
  - "並列計算"
  - "データ処理"
  - "Google"
  - "ビッグデータ"
"date": "2019-11-25"
---

## 起源

著者らは、膨大な量のデータを扱う業務において、数百種類のデータ処理プログラムを作成しました。それらには以下の特徴がありました：

1.  ビジネスロジックは単純である
2.  データ量が膨大なため、数百台のコンピュータ上で分散計算を行う必要がある

これにより、以下の課題が提起されました：

1.  並列計算をどのように行うか
2.  データをどのように分散させるか
3.  フォールトトレランスをどのように実現するか

データ処理プログラムの多くのコードは、ビジネスロジックの記述ではなく、このような類似の問題を処理することに費やされていました。

そこで、新しい抽象化の方法が提案されました。Lispやその他の関数型言語から借用した2つの概念により、エンジニアはビジネスロジックに集中し、上記の非機能要件を隠蔽することができます。これがMap-Reduceです。

## 実装

### 実行ロジック

1.  入力データはM個のスライスに分割され、M個のMapワーカーに割り当てられます。
2.  Masterはデータパイプラインとしてスケジューリングを行います。
3.  Mapタスクはユーザー定義のMapメソッドを呼び出して処理し、結果をローカルメモリに格納します。
4.  定期的にディスクにダンプされ、さらにR個の部分に分割されて、R個のReduceワーカーに割り当てられる準備をします。
5.  Reduceワーカーは、Masterからタスクを割り当てられた後、RPCを介してデータを読み取り、読み終わったらディスク上でソートします。
6.  Reduceワーカーは、ソートされたデータに対してユーザー定義のReduceメソッドを呼び出して反復処理を行い、インクリメンタルな計算を行います。
7.  計算が完了すると、処理は終了し、ユーザーコードのロジックに戻ります。

Partition（分割）の方法が重要であり、不必要なシャッフリングを避けることが望ましいことがわかります。

### データ構造

-   各map/reduceタスクの状態（idle/inprogress/completed）を保存します。
-   完了した各mapタスクについて、中間ファイルの位置とサイズを保存し、reduceワーカーに通知します。

### フォールトトレランス

-   Masterは基本的に故障しませんが、状態を定期的に保存し、故障後に復旧する方法も採用できます。
-   Masterは定期的にワーカーにpingを送信し、応答がない場合はそのワーカーを故障と見なします。
    -   mapタスクについては、完了の有無にかかわらずすべてリセットして再スケジューリングします。これは、mapの結果がワーカーのローカルに保存されるため、ワーカーが故障すると結果にもアクセスできなくなるからです。
    -   reduceタスクについては、未完了のもののみを再スケジューリングします。これは、reduceの結果はグローバルにアクセス可能なファイルシステムに配置されるからです。
    -   mapタスクが再スケジューリングされると、すべてのreduceワーカーに通知されるため、新しい位置からデータを取得します。

### バックアップタスク

最後に実行されているいくつかのタスクがMRの進行を大幅に遅らせる可能性があります。その原因の一つは「落伍者」の存在であり、様々な理由で実行速度が極端に遅くなることがあります。この場合、masterは最後に実行されているいくつかのタスクに対してバックアップタスクを起動します。これによりリソース使用率は数パーセント増加しますが、実行時間を大幅に短縮することができます。

## 改良点

### Partition

出力ファイルは分散されているため、ユーザー提供のパーティション関数を使用して、関連するキーの結果をまとめることが可能です。

### ローカルデバッグ

ローカル環境で実行することができます。

## 性能

2つの大規模クラスタでテストを行いました。1つはソート用、もう1つはパターンマッチング用です。

### grep

10^10個の100バイトファイルからパターンを検索しました。1.7k台のマシンで150秒かかり、そのうちプログラムの配布に1分を要しました。

### sort

10^10個の100バイトファイルをソートしました。

## まとめ

確固たる基盤を持つフレームワークです。