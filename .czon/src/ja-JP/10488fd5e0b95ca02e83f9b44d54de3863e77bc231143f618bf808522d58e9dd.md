---
"title": "MapReduce 論文ノート"
"summary": "本稿はMapReduce論文に関するノートであり、MapReduceの起源、実行ロジック、データ構造、フォールトトレランス機構、パフォーマンス最適化について詳細に解析しています。MapReduceは大規模データ処理における並列計算、データ分散、フォールトトレランスの課題を解決するために提案された抽象モデルであり、関数型プログラミングのMapとReduceの概念を借用しています。実装部分には、タスク分割、Masterスケジューリング、中間結果の保存、バックアップタスクなどの重要な要素が含まれます。フォールトトレランスについては、Masterによる監視とタスクの再スケジューリングによって信頼性を確保しています。パフォーマンステストでは、grepおよびソートタスクにおける高い効率性を示しています。まとめとして、MapReduceが分散計算に簡潔で強力なプログラミングモデルを提供している点を強調しています。"
"tags":
  - "MapReduce"
  - "分散システム"
  - "論文ノート"
  - "フォールトトレランス"
  - "パフォーマンス最適化"
  - "データ処理"
"date": "2019-11-25"
---

## 起源

著者らは、膨大な量のデータを扱う業務において、数百種類のデータ処理プログラムを作成しました。これらのプログラムにはいくつかの特徴がありました：

1.  ビジネスロジックは単純である
2.  データ量が膨大なため、数百台のコンピュータ上で分散計算を行う必要がある

これにより、以下のような課題が生じました：

1.  並列計算をどのように行うか
2.  データをどのように分散させるか
3.  フォールトトレランスをどのように実現するか

データ処理プログラムの多くのコードは、ビジネスロジックそのものではなく、こうした類似の問題を処理することに費やされていました。

そこで、新しい抽象化の方法が提案されました。Lispやその他の関数型言語から借用した2つの概念を用いることで、エンジニアはビジネスロジックに集中し、上記のような非機能要件を隠蔽することができます。これがMapReduceです。

## 実装

### 実行ロジック

1.  入力データをM個の断片に分割し、M個のMapワーカーに割り当てる
2.  Masterがデータパイプラインとしてスケジューリングを行う
3.  Mapタスクはユーザー定義のMapメソッドを呼び出し、処理結果をローカルメモリに保存する
4.  定期的にディスクにダンプし、さらにR個の断片に分割してR個のReduceワーカーに割り当てる準備をする
5.  Reduceワーカーは、Masterからタスクを割り当てられた後、RPCを通じてデータを読み込み、読み込み完了後にディスク上でソートを行う
6.  Reduceワーカーは、ソート済みデータに対してユーザー定義のReduceメソッドを呼び出し、反復処理を行いながらインクリメンタルな計算を行う
7.  計算が完了すると、処理は終了し、制御はユーザーコードのロジックに戻る

ここで、Partition（分割）の方法が重要であり、不必要なシャッフリングを避けることが望ましいことがわかります。

### データ構造

-   各map/reduceタスクの状態（idle/inprogress/completed）を保存する
-   完了した各mapタスクについて、中間ファイルの位置とサイズを保存し、reduceワーカーに通知する

### フォールトトレランス

-   Masterは基本的に故障しないが、状態を定期的に保存し、故障後に復旧する方法も採用可能である
-   Masterは定期的にワーカーにpingを送信し、応答がない場合はそのワーカーを故障とみなす
    -   mapタスクについては、完了の有無にかかわらずすべてリセットして再スケジューリングする。これは、mapの結果がワーカーのローカルに保存されるため、ワーカーが故障すると結果にもアクセスできなくなるからである。
    -   reduceタスクについては、未完了のもののみを再スケジューリングする。これは、reduceの結果はグローバルにアクセス可能なファイルシステムに保存されるためである。
    -   mapタスクが再スケジューリングされると、すべてのreduceワーカーに通知されるため、新しい位置からデータを取得するようになる。

### バックアップタスク

最後に実行されているいくつかのタスクが、MapReduceの進行を大幅に遅らせる可能性があります。これは、何らかの理由で実行速度が極端に遅い「遅延タスク」が存在する可能性があるためです。この場合、masterは最後に実行されているいくつかのタスクに対してバックアップタスクを起動します。これによりリソース使用率は数パーセント増加しますが、実行時間を大幅に短縮することができます。

## 改良点

### Partition

出力ファイルは分散されているため、ユーザーが提供するpartition関数を使用して、関連するキーの結果をまとめることが可能です。

### ローカルデバッグ

ローカル環境で実行することができます。

## パフォーマンス

大規模な2つのクラスタでテストを行いました。1つはソート用、もう1つはパターンマッチング用です。

### grep

10^10個の100バイトファイルからパターンを検索しました。1.7k台のマシンで150秒かかり、そのうちプログラムの配布に1分を要しました。

### sort

10^10個の100バイトファイルをソートしました。

## まとめ

MapReduceは、その有効性について確固たる自信を持っています。